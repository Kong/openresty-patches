From 474cf31fe460ad57dc432242275fdb86db8c1cb2 Mon Sep 17 00:00:00 2001
From: Thibault Charbonnier <thibaultcha@me.com>
Date: Thu, 7 Feb 2019 15:44:38 -0800
Subject: [PATCH] tests: switched to 127.0.0.2 instead of agentzh.org for
 timeout-related tests.

---
 .travis.yml                        |  2 ++
 t/023-rewrite/client-abort.t       |  4 ++--
 t/023-rewrite/tcp-socket-timeout.t | 12 ++++++------
 t/023-rewrite/tcp-socket.t         |  4 ++--
 t/023-rewrite/uthread-exit.t       |  4 ++--
 t/024-access/client-abort.t        |  4 ++--
 t/024-access/uthread-exit.t        |  2 +-
 t/027-multi-capture.t              |  2 +-
 t/030-uri-args.t                   |  4 ++--
 t/058-tcp-socket.t                 |  6 +++---
 t/065-tcp-socket-timeout.t         | 22 +++++++++++-----------
 t/090-log-socket-errors.t          | 10 +++++-----
 t/094-uthread-exit.t               |  2 +-
 t/100-client-abort.t               |  4 ++--
 t/127-uthread-kill.t               |  6 +++---
 t/128-duplex-tcp-socket.t          |  6 +++---
 t/147-tcp-socket-timeouts.t        |  4 ++--
 17 files changed, 50 insertions(+), 48 deletions(-)

diff --git a/.travis.yml b/.travis.yml
index fcf369e9..195f678e 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -96,6 +96,8 @@ before_script:
 
 script:
   - sudo iptables -I OUTPUT 1 -p udp --dport 10086 -j REJECT
+  - sudo iptables -A OUTPUT -p tcp --dst 127.0.0.2 --dport 12345 -j DROP
+  - sudo iptables -A OUTPUT -p udp --dst 127.0.0.2 --dport 12345 -j DROP
   - cd luajit2/
   - make -j$JOBS CCDEBUG=-g Q= PREFIX=$LUAJIT_PREFIX CC=$CC XCFLAGS='-DLUA_USE_APICHECK -DLUA_USE_ASSERT -msse4.2' > build.log 2>&1 || (cat build.log && exit 1)
   - sudo make install PREFIX=$LUAJIT_PREFIX > build.log 2>&1 || (cat build.log && exit 1)
diff --git a/t/023-rewrite/client-abort.t b/t/023-rewrite/client-abort.t
index 117d17e5..15f67d14 100644
--- a/t/023-rewrite/client-abort.t
+++ b/t/023-rewrite/client-abort.t
@@ -199,7 +199,7 @@ bad things happen
 
     location = /sub {
         proxy_ignore_client_abort on;
-        proxy_pass http://agentzh.org:12345/;
+        proxy_pass http://127.0.0.2:12345/;
     }
 
     location = /sleep {
@@ -240,7 +240,7 @@ client prematurely closed connection
 
     location = /sub {
         proxy_ignore_client_abort off;
-        proxy_pass http://agentzh.org:12345/;
+        proxy_pass http://127.0.0.2:12345/;
     }
 --- request
 GET /t
diff --git a/t/023-rewrite/tcp-socket-timeout.t b/t/023-rewrite/tcp-socket-timeout.t
index 329c0451..e713bb57 100644
--- a/t/023-rewrite/tcp-socket-timeout.t
+++ b/t/023-rewrite/tcp-socket-timeout.t
@@ -46,7 +46,7 @@ __DATA__
     location /t1 {
         rewrite_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -63,7 +63,7 @@ GET /t1
 failed to connect: timeout
 --- error_log
 lua tcp socket connect timeout: 100
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
@@ -79,7 +79,7 @@ lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
         rewrite_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(150)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -114,7 +114,7 @@ lua tcp socket connect timeout: 150
         rewrite_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(nil)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -149,7 +149,7 @@ lua tcp socket connect timeout: 102
         rewrite_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(0)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -185,7 +185,7 @@ lua tcp socket connect timeout: 102
         rewrite_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(-1)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
diff --git a/t/023-rewrite/tcp-socket.t b/t/023-rewrite/tcp-socket.t
index 41aeab74..37f86507 100644
--- a/t/023-rewrite/tcp-socket.t
+++ b/t/023-rewrite/tcp-socket.t
@@ -304,7 +304,7 @@ qr/connect\(\) failed \(\d+: Connection refused\)/
     location /test {
         rewrite_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             ngx.say("connect: ", ok, " ", err)
 
             local bytes
@@ -329,7 +329,7 @@ send: nil closed
 receive: nil closed
 close: nil closed
 --- error_log
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
diff --git a/t/023-rewrite/uthread-exit.t b/t/023-rewrite/uthread-exit.t
index 6ebbb678..fe9db07b 100644
--- a/t/023-rewrite/uthread-exit.t
+++ b/t/023-rewrite/uthread-exit.t
@@ -311,7 +311,7 @@ exiting the user thread
             ngx.thread.spawn(f)
             ngx.say("after")
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -521,7 +521,7 @@ after
             ngx.say("after")
             local sock = ngx.socket.tcp()
             sock:settimeout(12000)
-            local ok, err = sock:connect("172.105.207.225", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
diff --git a/t/024-access/client-abort.t b/t/024-access/client-abort.t
index c16f4eaa..107d9cb5 100644
--- a/t/024-access/client-abort.t
+++ b/t/024-access/client-abort.t
@@ -200,7 +200,7 @@ bad things happen
 
     location = /sub {
         proxy_ignore_client_abort on;
-        proxy_pass http://agentzh.org:12345/;
+        proxy_pass http://127.0.0.2:12345/;
     }
 
     location = /sleep {
@@ -241,7 +241,7 @@ client prematurely closed connection
 
     location = /sub {
         proxy_ignore_client_abort off;
-        proxy_pass http://agentzh.org:12345/;
+        proxy_pass http://127.0.0.2:12345/;
     }
 --- request
 GET /t
diff --git a/t/024-access/uthread-exit.t b/t/024-access/uthread-exit.t
index 02c2a1f9..de8f539d 100644
--- a/t/024-access/uthread-exit.t
+++ b/t/024-access/uthread-exit.t
@@ -502,7 +502,7 @@ after
             ngx.say("after")
             local sock = ngx.socket.tcp()
             sock:settimeout(12000)
-            local ok, err = sock:connect("172.105.207.225", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
diff --git a/t/027-multi-capture.t b/t/027-multi-capture.t
index 9227fe53..cfb935ed 100644
--- a/t/027-multi-capture.t
+++ b/t/027-multi-capture.t
@@ -743,7 +743,7 @@ proxy_cache_path conf/cache levels=1:2 keys_zone=STATIC:10m inactive=10m max_siz
 
     location = /proxy {
             proxy_cache STATIC;
-            proxy_pass http://agentzh.org:12345;
+            proxy_pass http://127.0.0.2:12345;
             proxy_cache_key $proxy_host$uri$args;
             proxy_cache_valid any 1s;
             #proxy_http_version 1.1;
diff --git a/t/030-uri-args.t b/t/030-uri-args.t
index a9d46ff9..de3eb0d4 100644
--- a/t/030-uri-args.t
+++ b/t/030-uri-args.t
@@ -421,7 +421,7 @@ done
             ngx.req.set_uri_args("hello")
             ngx.req.set_uri("/bar", true);
         ';
-        proxy_pass http://agentzh.org:12345;
+        proxy_pass http://127.0.0.2:12345;
     }
 --- request
     GET /foo?world
@@ -568,7 +568,7 @@ HTTP/1.0 ca%20t=%25
             ngx.req.set_uri("/bar", true);
             ngx.exit(503)
         ';
-        proxy_pass http://agentzh.org:12345;
+        proxy_pass http://127.0.0.2:12345;
     }
 --- request
     GET /foo?world
diff --git a/t/058-tcp-socket.t b/t/058-tcp-socket.t
index 354a8768..2df1ed1f 100644
--- a/t/058-tcp-socket.t
+++ b/t/058-tcp-socket.t
@@ -298,7 +298,7 @@ qr/connect\(\) failed \(\d+: Connection refused\)/
     location /test {
         content_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             ngx.say("connect: ", ok, " ", err)
 
             local bytes
@@ -321,7 +321,7 @@ send: nil closed
 receive: nil closed
 close: nil closed
 --- error_log
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
@@ -3315,7 +3315,7 @@ close: 1 nil
 
             local thr = ngx.thread.spawn(function ()
                 sock = ngx.socket.tcp()
-                local ok, err = sock:connect("agentzh.org", 12345)
+                local ok, err = sock:connect("127.0.0.2", 12345)
                 if not ok then
                     ngx.say("failed to connect: ", err)
                     return
diff --git a/t/065-tcp-socket-timeout.t b/t/065-tcp-socket-timeout.t
index 78b8cff7..f32b26d5 100644
--- a/t/065-tcp-socket-timeout.t
+++ b/t/065-tcp-socket-timeout.t
@@ -51,7 +51,7 @@ __DATA__
     location /t {
         content_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -66,7 +66,7 @@ GET /t
 failed to connect: timeout
 --- error_log
 lua tcp socket connect timeout: 100
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
@@ -81,7 +81,7 @@ lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
         content_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(150)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -96,7 +96,7 @@ GET /t
 failed to connect: timeout
 --- error_log
 lua tcp socket connect timeout: 150
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
@@ -110,7 +110,7 @@ lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
         content_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(nil)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -125,7 +125,7 @@ GET /t
 failed to connect: timeout
 --- error_log
 lua tcp socket connect timeout: 102
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 
 
 
@@ -139,7 +139,7 @@ lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
         content_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(0)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -154,7 +154,7 @@ GET /t
 failed to connect: timeout
 --- error_log
 lua tcp socket connect timeout: 102
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
@@ -168,7 +168,7 @@ lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
         content_by_lua '
             local sock = ngx.socket.tcp()
             sock:settimeout(-1)
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
@@ -683,7 +683,7 @@ after
     location /t {
         content_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("1: failed to connect: ", err)
 
@@ -707,7 +707,7 @@ GET /t
 2: connected: 1
 --- error_log
 lua tcp socket connect timeout: 100
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
diff --git a/t/090-log-socket-errors.t b/t/090-log-socket-errors.t
index 16576b6f..f5a9f80b 100644
--- a/t/090-log-socket-errors.t
+++ b/t/090-log-socket-errors.t
@@ -28,7 +28,7 @@ __DATA__
         lua_socket_log_errors off;
         content_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             ngx.say(err)
         ';
     }
@@ -50,7 +50,7 @@ timeout
         lua_socket_log_errors on;
         content_by_lua '
             local sock = ngx.socket.tcp()
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             ngx.say(err)
         ';
     }
@@ -59,7 +59,7 @@ GET /t
 --- response_body
 timeout
 --- error_log
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 
 
 
@@ -72,7 +72,7 @@ lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
         lua_socket_read_timeout 1ms;
         content_by_lua '
             local sock = ngx.socket.udp()
-            local ok, err = sock:setpeername("agentzh.org", 12345)
+            local ok, err = sock:setpeername("127.0.0.2", 12345)
             ok, err = sock:receive()
             ngx.say(err)
         ';
@@ -95,7 +95,7 @@ lua udp socket read timed out
         lua_socket_read_timeout 1ms;
         content_by_lua '
             local sock = ngx.socket.udp()
-            local ok, err = sock:setpeername("agentzh.org", 12345)
+            local ok, err = sock:setpeername("127.0.0.2", 12345)
             ok, err = sock:receive()
             ngx.say(err)
         ';
diff --git a/t/094-uthread-exit.t b/t/094-uthread-exit.t
index 2f7d9ba7..3f683a39 100644
--- a/t/094-uthread-exit.t
+++ b/t/094-uthread-exit.t
@@ -501,7 +501,7 @@ after
             ngx.say("after")
             local sock = ngx.socket.tcp()
             sock:settimeout(12000)
-            local ok, err = sock:connect("172.105.207.225", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             if not ok then
                 ngx.say("failed to connect: ", err)
                 return
diff --git a/t/100-client-abort.t b/t/100-client-abort.t
index 89c1f6ac..c7f885a7 100644
--- a/t/100-client-abort.t
+++ b/t/100-client-abort.t
@@ -195,7 +195,7 @@ bad things happen
 
     location = /sub {
         proxy_ignore_client_abort on;
-        proxy_pass http://agentzh.org:12345/;
+        proxy_pass http://127.0.0.2:12345/;
     }
 
     location = /sleep {
@@ -236,7 +236,7 @@ client prematurely closed connection
 
     location = /sub {
         proxy_ignore_client_abort off;
-        proxy_pass http://agentzh.org:12345/;
+        proxy_pass http://127.0.0.2:12345/;
     }
 --- request
 GET /t
diff --git a/t/127-uthread-kill.t b/t/127-uthread-kill.t
index cc43c627..db855fcd 100644
--- a/t/127-uthread-kill.t
+++ b/t/127-uthread-kill.t
@@ -138,12 +138,12 @@ lua clean up the timer for pending ngx.sleep
 
 === TEST 3: kill pending resolver
 --- config
-    resolver agentzh.org:12345;
+    resolver 127.0.0.2:12345;
     location /lua {
         content_by_lua '
             function f()
                 local sock = ngx.socket.tcp()
-                sock:connect("some.agentzh.org", 12345)
+                sock:connect("some.127.0.0.2", 12345)
             end
 
             local t, err = ngx.thread.spawn(f)
@@ -200,7 +200,7 @@ resolve name done: -2
                 sock:close()
                 ready = true
                 sock:settimeout(10000)
-                sock:connect("agentzh.org", 12345)
+                sock:connect("127.0.0.2", 12345)
             end
 
             local t, err = ngx.thread.spawn(f)
diff --git a/t/128-duplex-tcp-socket.t b/t/128-duplex-tcp-socket.t
index aed560c1..22b9f036 100644
--- a/t/128-duplex-tcp-socket.t
+++ b/t/128-duplex-tcp-socket.t
@@ -396,7 +396,7 @@ F(ngx_http_lua_socket_tcp_finalize_write_part) {
             end
 
             sock:settimeout(300)
-            local ok, err = sock:connect("172.105.207.225", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             ngx.say("connect: ", ok, " ", err)
 
             local ok, err = sock:close()
@@ -425,7 +425,7 @@ close: nil closed
 --- config
     server_tokens off;
     lua_socket_log_errors off;
-    resolver agentzh.org:12345;
+    resolver 127.0.0.2:12345;
     resolver_timeout 300ms;
     location /t {
         content_by_lua '
@@ -459,7 +459,7 @@ close: nil closed
             end
 
             sock:settimeout(300)
-            local ok, err = sock:connect("some2.agentzh.org", 12345)
+            local ok, err = sock:connect("some2.agentzh.org", 80)
             ngx.say("connect: ", ok, " ", err)
 
             local ok, err = sock:close()
diff --git a/t/147-tcp-socket-timeouts.t b/t/147-tcp-socket-timeouts.t
index 4ebc8f37..09bb9eda 100644
--- a/t/147-tcp-socket-timeouts.t
+++ b/t/147-tcp-socket-timeouts.t
@@ -323,7 +323,7 @@ lua tcp socket write timed out
 
             sock:settimeouts(100, 100, 100)
 
-            local ok, err = sock:connect("agentzh.org", 12345)
+            local ok, err = sock:connect("127.0.0.2", 12345)
             ngx.say("connect: ", ok, " ", err)
 
             local bytes
@@ -346,7 +346,7 @@ send: nil closed
 receive: nil closed
 close: nil closed
 --- error_log
-lua tcp socket connect timed out, when connecting to 172.105.207.225:12345
+lua tcp socket connect timed out, when connecting to 127.0.0.2:12345
 --- timeout: 10
 
 
-- 
2.20.1

